<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตู้เต่า IoT Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-h: 220;
            --primary-s: 70%;
            --primary-l: 50%;
            --primary-color: hsl(var(--primary-h), var(--primary-s), var(--primary-l));
            --primary-bg: hsl(var(--primary-h), var(--primary-s), 97%);
            --body-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: hsla(var(--primary-h), var(--primary-s), var(--primary-l), 0.3);
        }

        .dark {
            --body-bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: hsla(var(--primary-h), var(--primary-s), var(--primary-l), 0.4);
            --primary-bg: hsl(var(--primary-h), var(--primary-s), 15%);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .bg-card { background-color: var(--card-bg); }
        .border-base { border-width: 2px; border-color: var(--border-color); }
        .text-muted { color: var(--text-muted); }

        .sidebar-item-active { background-color: var(--primary-bg); color: var(--primary-color); border-right: 4px solid var(--primary-color); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .temp-circle { border: 4px dashed var(--primary-color); transition: all 0.5s ease; opacity: 0.8; }
        .online-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }

        @keyframes rainbow-text {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        .rainbow-active {
            animation: rainbow-text 3s linear infinite;
        }

        input[type=range].hue-slider {
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
            outline: none;
        }
        input[type=range].hue-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex" id="main-body">

    <!-- Sidebar -->
    <aside class="w-64 bg-card border-r border-base hidden lg:flex flex-col">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white"><i data-lucide="turtle"></i></div>
            <span class="text-xl font-bold tracking-tight">ตู้เต่า</span>
        </div>
        <nav class="flex-1 py-2">
            <div class="px-4 mb-2 text-xs font-semibold text-muted uppercase tracking-wider">เมนูหลัก</div>
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="sidebar-item-active w-full flex items-center px-6 py-3 text-sm font-medium transition-colors">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> แดชบอร์ด
            </button>
            <button onclick="switchTab('monitoring')" id="btn-monitoring" class="w-full flex items-center px-6 py-3 text-sm font-medium text-muted hover:bg-slate-100/10 transition-colors">
                <i data-lucide="activity" class="w-5 h-5 mr-3"></i> การตรวจสอบ
            </button>
            <button onclick="switchTab('records')" id="btn-records" class="w-full flex items-center px-6 py-3 text-sm font-medium text-muted hover:bg-slate-100/10 transition-colors">
                <i data-lucide="database" class="w-5 h-5 mr-3"></i> บันทึกข้อมูล
            </button>
            <button onclick="switchTab('settings')" id="btn-settings" class="w-full flex items-center px-6 py-3 text-sm font-medium text-muted hover:bg-slate-100/10 transition-colors mt-1">
                <i data-lucide="settings" class="w-5 h-5 mr-3"></i> ตั้งค่า
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="h-16 bg-card border-b border-base flex items-center justify-between px-8 z-10">
            <div class="flex items-center gap-2 text-sm text-muted">
                <span id="breadcrumb-parent">Dashboard</span>
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                <span class="text-main font-medium" id="breadcrumb-current">Analytics</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1 bg-slate-100 dark:bg-slate-800 border border-base rounded-full">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-400"></div>
                    <span id="status-text" class="text-xs font-medium text-muted">Connecting...</span>
                </div>
                
                <button onclick="toggleRainbow()" id="btn-rainbow" class="p-2 text-muted hover:text-main transition-colors" title="Rainbow Theme">
                    <i data-lucide="palette"></i>
                </button>

                <button onclick="toggleDarkMode()" class="p-2 text-muted hover:text-main transition-colors" title="Toggle Theme">
                    <i data-lucide="sun" id="theme-icon-sun"></i>
                    <i data-lucide="moon" id="theme-icon-moon" class="hidden"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <!-- TAB: DASHBOARD -->
            <div id="tab-dashboard" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-card p-6 rounded-xl border border-base card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-primary"><i data-lucide="thermometer"></i></div>
                            <span class="text-xs font-bold text-primary bg-[hsla(var(--primary-h),var(--primary-s),var(--primary-l),0.1)] px-2.5 py-1 rounded-md">Live</span>
                        </div>
                        <h3 class="text-muted text-sm font-medium">อุณหภูมิปัจจุบัน</h3>
                        <p class="text-2xl font-bold mt-1" id="stat-temp">--.- °C</p>
                    </div>
                    <div class="bg-card p-6 rounded-xl border border-base card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 rounded-lg"><i data-lucide="cpu"></i></div>
                        </div>
                        <h3 class="text-muted text-sm font-medium">สถานะอุปกรณ์</h3>
                        <p class="text-2xl font-bold mt-1" id="stat-status">Waiting</p>
                    </div>
                    <div class="bg-card p-6 rounded-xl border border-base card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-purple-50 dark:bg-purple-900/20 text-purple-600 rounded-lg"><i data-lucide="activity"></i></div>
                        </div>
                        <h3 class="text-muted text-sm font-medium">บันทึกทั้งหมด</h3>
                        <p class="text-2xl font-bold mt-1" id="stat-total-logs">0</p>
                    </div>
                    <div class="bg-card p-6 rounded-xl border border-base card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-lg"><i data-lucide="history"></i></div>
                        </div>
                        <h3 class="text-muted text-sm font-medium">อัปเดตล่าสุด</h3>
                        <p class="text-2xl font-bold mt-1 text-sm" id="stat-sync">--:--:--</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-card rounded-2xl border border-base card-shadow p-8 flex flex-col justify-center min-h-[400px]">
                        <div class="flex flex-col md:flex-row items-center gap-12">
                            <div class="relative">
                                <div id="temp-circle-container" class="w-64 h-64 rounded-full temp-circle flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-800/50">
                                    <span class="text-6xl font-extrabold text-primary tracking-tighter" id="big-temp-val">--.-</span>
                                    <span class="text-muted font-medium mt-1">Celsius</span>
                                </div>
                                <div id="online-indicator" class="absolute top-4 right-4 w-4 h-4 rounded-full bg-slate-300"></div>
                            </div>
                            <div class="flex-1 space-y-4">
                                <h2 class="text-3xl font-bold text-main leading-tight">Environmental Monitoring Center</h2>
                                <p class="text-muted">ระบบติดตามและบันทึกอุณหภูมิจาก Firebase Realtime Database ข้อมูลจะถูกแสดงผลทันทีที่ ESP32 ส่งมา</p>
                                <div class="pt-4 flex gap-3">
                                    <!-- ปุ่มนี้เปลี่ยนเป็น Force Refresh หน้าเว็บแทน -->
                                    <button onclick="window.location.reload()" class="px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:opacity-90 transition-all shadow-lg flex items-center gap-2">
                                        <i data-lucide="refresh-cw" class="w-5 h-5"></i> Refresh Page
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-card rounded-2xl border border-base card-shadow p-6">
                        <h3 class="font-bold text-main mb-6">Log ล่าสุดจาก ESP32</h3>
                        <div id="mini-records" class="space-y-4">
                            <div class="text-center py-10 text-muted text-sm">Waiting for data...</div>
                        </div>
                        <button onclick="switchTab('records')" class="w-full mt-6 py-3 text-sm font-semibold text-primary hover:bg-slate-100/10 rounded-xl transition-colors">View All Records</button>
                    </div>
                </div>
            </div>

            <!-- TAB: SETTINGS -->
            <div id="tab-settings" class="hidden max-w-2xl mx-auto">
                <div class="bg-card rounded-2xl border border-base card-shadow overflow-hidden">
                    <div class="p-8 border-b border-base">
                        <h2 class="text-2xl font-bold text-main">ตั้งค่าอินเตอร์เฟซ</h2>
                        <p class="text-muted">เลือกสีที่คุณต้องการเพียงแค่เลื่อนสไลเดอร์</p>
                    </div>
                    <div class="p-8 space-y-10">
                        <div>
                            <div class="flex justify-between items-center mb-6">
                                <label class="block text-lg font-bold text-main">เลือกโทนสีหลัก (Theme Color)</label>
                                <div id="hex-display" class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded font-mono font-bold text-primary border border-base">HSL(...)</div>
                            </div>
                            <input type="range" id="input-h" min="0" max="360" value="220" class="hue-slider" oninput="updateColorSystem()">
                        </div>
                        <div class="p-6 rounded-2xl border border-base flex items-center gap-4 bg-slate-50 dark:bg-slate-800/50">
                            <div class="w-12 h-12 rounded-full bg-primary shadow-lg border-2 border-white dark:border-slate-600"></div>
                            <div>
                                <p class="font-bold text-main">ตัวอย่างสีและขอบที่เลือก</p>
                                <p class="text-sm text-muted">ขอบของการ์ดจะเปลี่ยนตามสีที่คุณเลือก</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: MONITORING -->
            <div id="tab-monitoring" class="hidden">
                <div class="bg-card rounded-2xl border border-base card-shadow p-8 h-[500px] flex items-center justify-center text-center">
                    <div><i data-lucide="line-chart" class="w-16 h-16 text-slate-200 mx-auto mb-4"></i><p class="text-muted">ส่วนกราฟแสดงผล (Coming Soon)</p></div>
                </div>
            </div>

            <!-- TAB: RECORDS -->
            <div id="tab-records" class="hidden">
                 <div class="bg-card rounded-2xl border border-base card-shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 border-b border-base">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-muted uppercase">เวลา</th>
                                <th class="px-6 py-4 text-xs font-bold text-muted uppercase">อุณหภูมิ</th>
                                <th class="px-6 py-4 text-xs font-bold text-muted uppercase">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="full-records-body">
                            <tr><td colspan="3" class="px-6 py-10 text-center text-muted">No data received yet.</td></tr>
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>
    </main>

    <!-- FIREBASE & LOGIC SCRIPT -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- ตั้งค่า Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyA55KQWSV7LTD_vFmUEeEb62QpWyZYTK9k",
          authDomain: "taon-3b930.firebaseapp.com",
          databaseURL: "https://taon-3b930-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "taon-3b930",
          storageBucket: "taon-3b930.firebasestorage.app",
          messagingSenderId: "941236437650",
          appId: "1:941236437650:web:8f3c096a315267a73f9c4b"
        };

        // เริ่มต้น Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ตัวแปรสำหรับ Logic หน้าเว็บ
        let realRecords = [];
        let isOnline = false;
        let lastUpdate = 0;

        // --- ฟังชั่นหลัก: เชื่อมต่อ Firebase ---
        function startListening() {
            // ฟังข้อมูลที่ path 'sensors/data' (เราจะให้ ESP32 ส่งมาที่นี่)
            const sensorRef = ref(db, 'sensors/data');
            
            onValue(sensorRef, (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // มีข้อมูลส่งมา
                    lastUpdate = Date.now();
                    isOnline = true;
                    
                    // อัปเดต UI ด้วยข้อมูลใหม่
                    updateDashboard(data.temperature, data.timestamp);
                    
                    // เพิ่มลงในตารางประวัติ (ในหน้าเว็บ)
                    addLocalRecord(data.temperature, data.timestamp);
                }
            }, (error) => {
                console.error("Firebase Error:", error);
                isOnline = false;
                updateStatusUI();
            });
        }

        // --- ฟังก์ชันอัปเดตหน้าจอ ---
        function updateDashboard(temp, timestamp) {
            // อัปเดตตัวเลข
            const tempVal = parseFloat(temp).toFixed(1);
            document.getElementById('big-temp-val').innerText = tempVal;
            document.getElementById('stat-temp').innerText = tempVal + " °C";
            
            // อัปเดตเวลาล่าสุด
            document.getElementById('stat-sync').innerText = timestamp || new Date().toLocaleTimeString();
            
            updateStatusUI();
        }

        function updateStatusUI() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const onlineIndicator = document.getElementById('online-indicator');
            const statStatus = document.getElementById('stat-status');
            const tempContainer = document.getElementById('temp-circle-container');

            // เช็คว่าข้อมูลไม่อัปเดตนานเกิน 60 วินาทีหรือไม่ (ถ้าเกินถือว่า Offline)
            const now = Date.now();
            if (now - lastUpdate > 60000 && lastUpdate !== 0) {
                isOnline = false;
            }

            if (isOnline) {
                statusDot.className = "w-2 h-2 rounded-full bg-emerald-500 online-pulse";
                statusText.innerText = "Device Online (Firebase)";
                onlineIndicator.className = "absolute top-4 right-4 w-4 h-4 rounded-full bg-emerald-500 shadow-lg online-pulse";
                statStatus.innerText = "Online";
                statStatus.className = "text-2xl font-bold mt-1 text-emerald-600";
                tempContainer.style.backgroundColor = "var(--primary-bg)";
            } else {
                statusDot.className = "w-2 h-2 rounded-full bg-slate-300";
                statusText.innerText = "Device Offline";
                onlineIndicator.className = "absolute top-4 right-4 w-4 h-4 rounded-full bg-slate-300";
                statStatus.innerText = "Offline";
                statStatus.className = "text-2xl font-bold mt-1 text-muted";
                tempContainer.style.backgroundColor = "";
            }
        }

        // --- จัดการข้อมูล Record (UI Only) ---
        function addLocalRecord(temp, ts) {
            const timeStr = ts || new Date().toLocaleTimeString();
            // เช็คไม่ให้ซ้ำ (ถ้าค่าเดิมและเวลาเดิม)
            if (realRecords.length > 0 && realRecords[0].timestamp === timeStr && realRecords[0].value === parseFloat(temp).toFixed(1)) return;

            const newRecord = {
                timestamp: timeStr,
                date: new Date().toLocaleDateString(),
                value: parseFloat(temp).toFixed(1),
                status: 'REC'
            };
            realRecords.unshift(newRecord);
            if(realRecords.length > 50) realRecords.pop();
            
            // Render ตาราง
            updateRecordsTable();
            document.getElementById('stat-total-logs').innerText = realRecords.length;
        }

        function updateRecordsTable() {
            // Mini Table (หน้าแรก)
            const mini = document.getElementById('mini-records');
            mini.innerHTML = realRecords.slice(0, 4).map(r => `
                <div class="flex items-center justify-between p-3 bg-slate-100/50 dark:bg-slate-800/50 rounded-xl border border-base">
                    <div class="flex flex-col"><span class="text-xs text-muted">${r.timestamp}</span><span class="text-sm font-bold text-main">${r.value} °C</span></div>
                    <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded">${r.status}</span>
                </div>
            `).join('');

            // Full Table (หน้า Records)
            const body = document.getElementById('full-records-body');
            body.innerHTML = realRecords.map(r => `
                <tr class="hover:bg-slate-100/5 border-b border-base">
                    <td class="px-6 py-4 text-sm text-muted">${r.date}, ${r.timestamp}</td>
                    <td class="px-6 py-4 text-sm font-bold text-main">${r.value} °C</td>
                    <td class="px-6 py-4 text-sm"><span class="px-2 py-1 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 rounded text-xs font-bold">${r.status}</span></td>
                </tr>
            `).join('');
        }

        // --- เริ่มต้นการทำงาน ---
        window.addEventListener('load', () => {
            lucide.createIcons();
            loadPrefs(); // โหลดค่าสีที่เคยตั้งไว้ (Function เดิมที่อยู่ข้างล่าง)
            
            // เริ่มฟังข้อมูลจาก Firebase
            startListening();
            
            // เช็คสถานะ Offline ทุก 5 วินาที
            setInterval(updateStatusUI, 5000);
        });

    </script>

    <!-- Script เดิมสำหรับ UI Logic (ย้ายมาอยู่นอก module เพื่อให้ HTML เรียกใช้ได้) -->
    <script>
        // Global functions for HTML onclick events
        let isDarkMode = false;
        let isRainbow = false;

        function loadPrefs() {
            const h = localStorage.getItem('turtle_h') || 220;
            const dark = localStorage.getItem('turtle_dark') === 'true';
            const rainbow = localStorage.getItem('turtle_rainbow') === 'true';
            
            const inputH = document.getElementById('input-h');
            if(inputH) inputH.value = h;
            
            if(dark) toggleDarkMode();
            if(rainbow) toggleRainbow();
            applyColors(h);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            document.getElementById('theme-icon-sun').classList.toggle('hidden', isDarkMode);
            document.getElementById('theme-icon-moon').classList.toggle('hidden', !isDarkMode);
            localStorage.setItem('turtle_dark', isDarkMode);
        }

        function toggleRainbow() {
            isRainbow = !isRainbow;
            const mainBody = document.getElementById('main-body');
            const btn = document.getElementById('btn-rainbow');
            if(isRainbow) {
                mainBody.classList.add('rainbow-active');
                btn.classList.add('text-primary');
            } else {
                mainBody.classList.remove('rainbow-active');
                btn.classList.remove('text-primary');
            }
            localStorage.setItem('turtle_rainbow', isRainbow);
        }

        function updateColorSystem() {
            const h = document.getElementById('input-h').value;
            applyColors(h);
            localStorage.setItem('turtle_h', h);
        }

        function applyColors(h) {
            document.documentElement.style.setProperty('--primary-h', h);
            const color = `hsl(${h}, 70%, 50%)`;
            document.getElementById('hex-display').innerText = color;
        }

        function switchTab(tabId) {
            const tabs = ['dashboard', 'settings', 'monitoring', 'records'];
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).className = "w-full flex items-center px-6 py-3 text-sm font-medium text-muted hover:bg-slate-100/10 transition-colors";
            });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`btn-${tabId}`).className = "sidebar-item-active w-full flex items-center px-6 py-3 text-sm font-medium transition-colors";
            document.getElementById('breadcrumb-current').innerText = tabId.charAt(0).toUpperCase() + tabId.slice(1);
        }
    </script>
</body>
</html>